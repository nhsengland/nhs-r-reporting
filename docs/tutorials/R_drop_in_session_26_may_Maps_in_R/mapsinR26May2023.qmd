---
title: Maps in R using ggplot2 and OSM packages
subtitle: "NHSE R drop in session."
author: "Pablo Leon"
date: "2023-10-06"
categories: [NHS England]
---

```{r}
# Check if 'janitor' package is installed
# List of required packages
required_packages <- c("here",
                       "sf",
                       "ggplot2",
                       "readxl",
                       "dplyr",
                       "janitor"
                       )

# Check if required packages are not installed, then install and load them
for (package in required_packages) {
  if (!requireNamespace(package, quietly = TRUE)) {
    install.packages(package)
    if (!requireNamespace(package, quietly = TRUE)) {
      stop(paste("Failed to install and load", package, "package."))
    }
  }
}

# Now you can use the required packages in your script


# Now you can use the clean_names() function
```

## Intro {background="#43464B"}

These slides were presented in the NHSE-R drop in session on Friday 26th May 2023.

In R we can plot geospatial data using several methods, today I will focus on static maps using `ggplot2` and `osm` packages. Drawing maps usually imply these steps:

-   Getting shapefiles to draw a map
-   Obtaining metadata to plot on the map 
-   In R we load the multypoligon objects using `geom_sf()` and `coord_sf()`
-   Then we can take advantage of ggplot2 framework to overlay one map on top of another

An introduction to plotting maps in R using ggplot2 can be found on this online book: <https://ggplot2-book.org/maps.html>.



## 1. NHS Health boundaries{auto-animate="true" background="#43464B"}

The Office for National Statistics provides a free and open access to several geographic products. There is a specific section for `Health boundaries` on their `Open Geography Portal` website: <https://geoportal.statistics.gov.uk/>. 

From `Clinical Commissioning Groups` section download  `2021 Boundaries` **shapefile** zipped file.

::: columns
::: {.column width="40%"}

![Health Boundaries](Figures_maps_slides/02 Health boundaries.png)
:::

::: {.column width="60%"}

![Health Boundaries details](Figures_maps_slides/05 Unzip Shapefile.png)
:::
:::


## 2. Unzip CCG boundaries into R {background="#43464B"}

Load unzipped files into R using `Open Geography Portal` 

```{r echo=TRUE}
# Define a function to download and cache the CCG data
download_CCG_data <- function() {
  data_dir <- here::here("data") # Use here::here() for consistent path resolution
  
  # Check if the data directory exists, create it if not
  if (!dir.exists(data_dir)) {
    dir.create(data_dir, recursive = TRUE)
  }
  
  zip_file <- file.path(data_dir, "CCGoutcomes.zip")
  
  # Check if the file already exists, if not, download and unzip it
  if (!file.exists(zip_file)) {
    download.file(
      url = "https://files.digital.nhs.uk/48/4DB2CA/CCG_OIS_MAR_2022_Excels_Files.zip",
      destfile = zip_file
    )
    unzip(zip_file, exdir = data_dir, junkpaths = TRUE)
  }
}

# Call the function to download and cache the CCG data
download_CCG_data()
```

